name: "Terraform CI/CD"

# 1. When to run this workflow
on:
  push:
    branches:
      - main # Runs "apply" on merge to main
  pull_request:
    branches:
      - main # Runs "plan" on PRs to main

# 2. Permissions for the GitHub Action
# This is required for OIDC and for posting PR comments
permissions:
  id-token: write   # Allows the job to get an OIDC token from AWS
  contents: read    # Allows checkout
  pull-requests: write # Allows posting the "plan" as a comment

jobs:
  # ----------------------------------------------------
  # JOB 1: Validate and Format Check
  # Runs on all pushes and pull requests
  # ----------------------------------------------------
  validate:
    name: "Terraform Validate & Fmt"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Set up Terraform"
        uses: hashicorp/setup-terraform@v3

      - name: "Configure AWS credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: "us-west-1"

      - name: "Terraform Init"
        run: terraform init
      
      - name: "Terraform Format Check"
        run: terraform fmt -check
      
      - name: "Terraform Validate"
        run: terraform validate

  # ----------------------------------------------------
  # JOB 2: Generate Terraform Plan
  # Runs ONLY on pull requests
  # ----------------------------------------------------
  plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    needs: validate # Depends on the "validate" job passing first
    if: github.event_name == 'pull_request'

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4
      
      - name: "Set up Terraform"
        uses: hashicorp/setup-terraform@v3
      
      - name: "Configure AWS credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: "us-west-1"
          
      - name: "Terraform Init"
        run: terraform init

      - name: "Terraform Plan"
        id: tf-plan # Gives this step an ID
        run: terraform plan -no-color -out=tfplan
      
      # This magical action takes the plan and posts it as a PR comment
      - name: "Update PR with plan"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment => comment.user.login === 'github-actions[bot]');
            
            const output = `#### Terraform Plan ðŸ“–
            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`
            *Pushed by: @${{ github.actor }}*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }
        env:
          PLAN: ${{ steps.tf-plan.outputs.stdout }}

  # ----------------------------------------------------
  # JOB 3: Apply Terraform Plan
  # Runs ONLY on merge to main
  # ----------------------------------------------------
  apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    needs: validate # Depends on the "validate" job passing first
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    # 1. Use the "production" environment we created
    environment:
      name: production
      url: ${{ steps.lb-output.outputs.load_balancer_dns }} # Updates the environment with the URL

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Set up Terraform"
        uses: hashicorp/setup-terraform@v3

      - name: "Configure AWS credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: "us-west-1"

      - name: "Terraform Init"
        run: terraform init

      # 2. This apply is safe because the GitHub Environment
      #    forced a manual approval before this job could even start.
      - name: "Terraform Apply"
        run: terraform apply -auto-approve

      # 3. Get the load_balancer_dns output to display in the UI
      - name: "Get LB Output"
        id: lb-output
        run: echo "load_balancer_dns=$(terraform output -raw load_balancer_dns)" >> $GITHUB_OUTPUT
